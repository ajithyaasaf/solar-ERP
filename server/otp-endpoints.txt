  // ==================== OTP VERIFICATION ENDPOINTS ====================
  
  /**
   * Send OTP to email for registration verification
   */
  app.post("/api/auth/send-otp", async (req, res) => {
    try {
      const { email } = req.body;
      
      // Validate and normalize email
      const normalized = email?.trim().toLowerCase();
      if (!normalized) {
        return res.status(400).json({ message: "Email is required" });
      }
      
      // Gmail validation
      if (!normalized.endsWith('@gmail.com') && !normalized.endsWith('@googlemail.com')) {
        return res.status(400).json({ 
          message: "Only Gmail addresses (@gmail.com or @googlemail.com) are accepted"
        });
      }
      
      // Basic email format validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(normalized)) {
        return res.status(400).json({ message: "Invalid email format" });
      }
      
      // Rate limiting: Check if can request new OTP
      const rateLimitCheck = otpStore.canRequestNew(normalized);
      if (!rateLimitCheck.allowed) {
        return res.status(429).json({ 
          message: `Please wait before requesting another code`,
          retryAfter: rateLimitCheck.retryAfter
        });
      }
      
      // Check if email already registered
      try {
        const existingUser = await storage.getUserByEmail(normalized);
        if (existingUser) {
          return res.status(400).json({ 
            message: "This email is already registered. Please login instead."
          });
        }
      } catch (error) {
        // getUserByEmail might throw if user not found, that's okay
        console.log("No existing user found, proceeding with OTP");
      }
      
      // Generate OTP
      const otp = generateOTP(OTP_CONFIG.LENGTH);
      
      // Store OTP
      otpStore.set(normalized, otp);
      
      // Send email
      try {
        await emailService.sendOTPEmail(normalized, otp);
      } catch (emailError) {
        console.error("Failed to send OTP email:", emailError);
        otpStore.delete(normalized);
        return res.status(500).json({ 
          message: "Failed to send verification code. Please try again."
        });
      }
      
      res.json({ 
        message: "Verification code sent to your email",
        expiresIn: OTP_CONFIG.EXPIRY_MINUTES * 60 // seconds
      });
      
    } catch (error) {
      console.error("Error sending OTP:", error);
      res.status(500).json({ message: "Failed to send verification code" });
    }
  });

  /**
   * Verify OTP code
   */
  app.post("/api/auth/verify-otp", async (req, res) => {
    try {
      const { email, otp } = req.body;
      
      const normalized = email?.trim().toLowerCase();
      if (!normalized || !otp) {
        return res.status(400).json({ message: "Email and OTP are required" });
      }
      
      // Validate OTP format
      if (!validateOTPFormat(otp)) {
        return res.status(400).json({ message: "Invalid OTP format. Must be 6 digits." });
      }
      
      // Get stored OTP
      const storedOTP = otpStore.get(normalized);
      if (!storedOTP) {
        return res.status(400).json({ 
          message: "No verification code found. Please request a new one."
        });
      }
      
      // Check expiration
      if (otpStore.isExpired(normalized)) {
        otpStore.delete(normalized);
        return res.status(400).json({ 
          message: "Verification code expired. Please request a new one."
        });
      }
      
      // Check attempts
      if (storedOTP.attempts >= OTP_CONFIG.MAX_ATTEMPTS) {
        otpStore.delete(normalized);
        return res.status(400).json({ 
          message: "Too many failed attempts. Please request a new code."
        });
      }
      
      // Verify OTP
      if (storedOTP.otp !== otp) {
        storedOTP.attempts++;
        otpStore.update(normalized, { attempts: storedOTP.attempts });
        
        const remaining = OTP_CONFIG.MAX_ATTEMPTS - storedOTP.attempts;
        return res.status(400).json({ 
          message: `Incorrect verification code. ${remaining} attempt(s) remaining.`
        });
      }
      
      // Success! Mark as verified
      otpStore.update(normalized, { verified: true });
      
      res.json({ 
        message: "Email verified successfully",
        verified: true
      });
      
    } catch (error) {
      console.error("Error verifying OTP:", error);
      res.status(500).json({ message: "Failed to verify code" });
    }
  });
